# Webを見ているときに起きていること

## スマホでWebサイトを見るとき、何が起きているのか？

現代ではWebのことをインターネットと呼ぶ人が増えています。Webを見ることが生活の一部になりました。
インターネット通信していることを意識せずに使っていると、手もとの機器にあらゆる情報が詰まっているように錯覚することもあるようです。

実際には、必要に応じてインターネットに接続されている「Webサーバ」から情報を取得しています。

---

日本のユーザーがアメリカにあるサーバと通信することを例にします。全体像として以下のように回線を分けて考えてみます。

- 家庭内LAN
- 家庭から収容局まで
- 収容局から陸揚局までの日本国内回線
- 太平洋横断回線
- 陸揚局からデータセンターまでのアメリカ国内回線
- データセンター内の回線

### 家庭内LAN

各家庭が自身で用意します。電化製品店などで市販されているLANケーブルや、無線LANなどです。

### 収容局

光ファイバや銅線による有線や、モバイル通信サービスによる無線回線などで、収容局を通過します。

### 陸揚局/太平洋横断回線

日本のデータを海外へ運ぶために、海を越える必要があります。
太平洋を越える通信には、海底に敷設された光海底ファイバを通じて行われます。
この海底回線と陸上の回線をつなげているのが、陸揚局です。

このように様々な国内外の物理的な方法によって、手もとの機器が通信を行うことができています。
インターネットは、様々な運営主体が互いにつなぎ合って構成された巨大ネットワークなのです。

## Webの住所、URL

世界中無数にあるWebサーバから、特定の情報を表現したものが**URL（Uniform Resource Locator）**です。
URLはWeb以外のリソースも表現できる仕組みになっています。

```
// URLの例
http://www.example.com/welcome.html
```

|URLのどの部分か|名前|
|---|---|
|http://|scheme|
|www.example.com|host|
|/welcome.html|path|

### scheme (スキーム)

URLの先頭部分がschemeにあたります。
schemeとは、計画・体系・仕組みといった意味があり、そのURLがどういったものであるかを示す役割をもちます。

#### http

`HyperText Transfer Protcol` の略で、WebブラウザとWebサーバ間のコンテンツのやり取りの方法を規定したもの。

#### https

通信を暗号化することで安全にHTTP通信を行うためのもの。

### host (ホスト)

「このサーバにWebコンテンツがありますよ」ということを示しています。

### path (パス)

hostに対して、どのコンテンツが欲しいかを要求するためのものです。

## URLを指定されたWebブラウザの動作

1. hostをもとに**IPアドレス**を調べる
2. 指定のIPアドレスへ、**TCPの80番ポート**で接続を試みる
3. 接続成功した場合、**HTTPのリクエストメッセージ**を送信する
4. HTTPメッセージを受け取る
5. 受け取ったメッセージの内容を解釈し、画面の描画をする

## IPアドレス

多少語弊のある表現ですが、IPアドレスとは**「インターネットに接続された機器の住所」**のようなものです。

IP(Internet Protocol)とは、インターネットの通信手段を規定したものです。
つまり、IPというプロトコルにおけるアドレス（住所、宛先）がIPアドレスということになります。

### IPv4

現在のインターネットでは、IPバージョン4(IPv4)によって多くが構成されています。
IPv4は2進数で表現されている「ビット」を32個並べたものです。

||IPv4|
|---|---|
|本来の形|11000000000000000000001000000001|
|ドットで8ビッドずつに分ける|11000000.00000000.00000010.00000001|
|ドット付き十進表記<br>（dotted decimal notation）|192.0.2.1|

IPv4は32桁の2進数なので、2の32乗、つまり**42億9496万7296個**の数を表現できます。

### n進数

コンピュータでは2進数/8進数/16進数がよく使われます。
2進数の各桁は1ビット、8進数は3ビット、16進数は4ビットを表現しているからという理由があります。

現在のコンピュータは8ビットを**「1オクテット」**という単位でまとめて扱うものが多いです。
8ビットすべてが1である場合（つまり2進数表記だと「11111111」）、10進数では255、16進数では0xffと表記されます。

## TCPの80番ポートへ接続する

TCP(Transmission Control Protocol)は、接続が成功してからデータのやり取りをするプロトコルです。

TCPは**バーチャルサーキット**と呼ばれる、論理的な通信回路を実現します。
バーチャルサーキットは「どこでもドア」のように、データを入れると反対側へデータが転送される、仮想的な回線です。

TCPにはポート番号という概念があり、HTTPでWebコンテンツのやり取りを行う場合は80番と決まっています。ほかにも、メールサーバは25番といった具合です。

IPアドレスの他に、ポート番号がある意味としては以下のような例えを用いると理解がしやすいです。

- IPアドレス：マンション
- ポート番号：部屋番号

こうすることで、１つのIPアドレス（マンション）内に複数のサービス（部屋）を置くことができます。

つまり、標準的なTCPポート番号をつかって運用していた場合、同じIPアドレスでも80番ポートに接続すればWebサーバにアクセスでき、25番ポートに接続すればメールサーバにアクセスができる、ということです。

※TCP自体の詳細はchapter-4へ

## HTTPのリクエストメッセージを送信する

HTTPバージョン1.1(HTTP/1.1)でのリクエストメッセージの例

```
GET /welcome.html HTTP/1.1 // リクエストライン
Host:www.example.com       // ヘッダ
Accept-Language:ja
                           // 空の改行
```

### リクエストライン

`[メソッド] [URI] [バージョン][改行コード]`

#### メソッド

|メソッド|役割|
|---|---|
|GET|リソースをWebサーバから取り出す|
|POST|Webサーバに対してデータを送信する|
|HEAD|コンテンツ本体を取得せずに、HTTPヘッダまで取得する|
|PUT|Webサーバ上で新たにリソースを作成する<br>(※POSTと違い、URLで示されるリソースに対しての処理で使われることが多い)|
|DELETE|リソースの削除をする|
|OPTIONS|Webサーバの情報を得る|
|TRACE|クライアント側が出すリクエストをそのまま返す|
|CONNECT|プロキシサーバを経由してWebサーバに接続する|

### ヘッダ

`[名前]:[値][改行コード]`

ヘッダは複数行書くことができて、すべて終わったことは空の改行コードで示されます。
つまり改行コードが連続で続くことで、ヘッダの終わりということになります。

## HTTPメッセージを受け取り、表示する

HTTPバージョン1.1(HTTP/1.1)でのレスポンスメッセージの例

```
HTTP/1.1 200 OK                 // ステータスライン
Date:Fri,1Apr 2016 11:22:33 JST // ヘッダ
Server:Apache 2.4.99
Content-Length:174
Content-Type:text/html
Connection:Closed
                                // 改行
<!DOCTYPE html>                 // ボディ
<html>
<head>
    <title>Document</title>
</head>
<body>
    <p>Contents</p>
    <img src="foo.png" alt="">
</body>
</html>
```

### ステータスライン

`[バージョン] [ステータスコード] [解説文][改行コード]`

#### ステータスコード

|ステータスコード|意味|
|---|---|
|100番台|情報|
|200番台|成功|
|300番台|リダイレクト|
|400番台|クライアントエラー|
|500番台|サーバエラー|

#### 解説文

ステータスコードの説明。人間が読める形になっています。
たとえば `404` の場合は、発見できないという意味の `Not Found` が書かれたりします。

### ヘッダ

サーバ側が付属情報として返すものです。
サーバのバージョン情報や、コンテンツの種類など。

### ボディ

HTTPはいろいろな種類のコンテンツを運ぶことができます。

例としてあげたものは、HTMLという言語で書かれたコンテンツなので受け取ったブラウザは、言語の解釈をし、描画（レンダリング）を開始します。

解釈の際に、imgタグによる画像の埋め込みがされていました。その場合、新たなHTTPリクエストをWebサーバに行い画像データを取得します。

このように必要に応じて何度も通信を繰り返すこともあります。

## www.example.comからコンテンツを取得してみる

HTTPリクエストは人間にわかりやすい形式になっているため、コマンドから簡単に実行ができます。

```
telnet www.example.com 80
```

## Webサーバからデータを取得するプログラムはこう書ける

`www.example.com` から `/` というパスに対する取得リクエストをするプログラムを言語別に紹介します。

### Ruby

```ruby
#!/usr/bin/ruby

require 'net/http'

result = Net::HTTP.get('www.example.com', '/')

p result
```

### Perl

```perl
#!/use/bin/perl

use HTTP::Lite;

$http = new HTTP::Lite;

$req = $http->request("http://www.example.com") || die $!;

print $http->body();
```

### PHP

```php
<?php

$contents = file_get_contents("http://www.example.com");

echo $contents;

?>
```

### Java

```java
import java.io.*;
import java.net.*;

public class SampleCode {
  public static void main(String args[]) {
    try {
      URL url = new URL("http://www.example.com");

      Object content = url.getContent();

      if (content instanceof InputStream) {
        BufferdReader reader =
          new BufferdReader(new InputStreamReader((InputStream)content));

        String str;
        while((str = reader.readLine()) != null) {
          System.out.printIn(str);
        }
      }

    } catch (Exception e) {
        System.err.printIn(e);
    }
  }
}

```

## 「HTTPだから簡単にできる」という側面も

サンプルコードは、どれも「ソケット」「ポート」を特に意識することせずに書くことができます。
これは、Webサーバからデータを取得するためにHTTPを使うということは、TCPの80番ポートを利用することが自明となるからです。

しかしHTTPではない通信を行おうとすると、同様に簡単に書けるとは限りません。
別の通信プロトコルを使った処理が必要な場合には、「ソケット」を利用したプログラムが求められることもあります。

直接ソケットを使う機会は少なくなったとしても、便利なツール・ライブラリでは内部的にソケットが使われています。

次章は「ソケット」の紹介です。

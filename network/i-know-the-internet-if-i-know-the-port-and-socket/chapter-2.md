# インターネットとUNIXとソケット

## パソコンの中の執事、「カーネル」

パソコンやスマホにはOSが稼働していますが、「OS」という単語はコンピュータそのものを動作させるための基本ソフトウェアである「カーネル」を示す場合と、各種ソフトウェア含めたパッケージ全体を示す場合があります。

カーネルは様々なハードウェアを制御するための執事のような役割を持ちます。コンピュータ制御においてカーネルはまさに中心部分にあたります。

例えばハードディスクにファイルを保存する場合、ハードディスク自身が「ファイル」という概念を持っているわけではありません。ユーザが扱いやすいように、カーネルが機能を抽象化してくれているからです。

## さまざまな作業を並行して実行！

通常CPUは同時に１つのことしかできませんが、カーネルが複数のアプリケーションを（「プロセス」という単位で）並行して行っています。これは「マルチタスク」と呼ばれます。

各プロセスに対して、短い実行時間を与え、高速に切り替えながら実行します。こうすることで、あたかも複数のプロセスが同時に実行されているように見えます。

プロセスは１つのハードウェアを共有しています。
同じハードウェアを同時に使用するときに不具合が生じないよう、カーネルは物理的なメモリではなく仮想メモリ空間を与えるため、**プロセスは他のプロセスへ干渉できません。**

## プロセス間通信

プロセスは、他のプロセスとやり取りを行うためには必ずカーネルを仲介する必要があります。

OSによってはアプリケーションがカーネルに対して依頼を行う仕組みを「システムコール」と呼んでいます。通信のための「ソケット」もシステムコールのひとつです。

これは異なるコンピュータへのプロセスに対しても同じで、インターネットを利用するためのソケットを介して通信相手を指定してやり取りを行います。

```
┌──────コンピュータA─────┐　　　　　　　　　┌──────コンピュータB─────┐
プロセス─(ソケット)─カーネル─[インターネット]─カーネル─(ソケット)─プロセス
```

なお、アプリケーションにとってインターネットの出入り口となるソケットは１つとは限りません。複数のソケットを使って同時に複数の画像ファイルをダウンロードしたりしています。

## UNIXにおける抽象化

UNIXにおいてソケットも「ファイル」の一種です。
すべての入出力を「ファイル」として抽象化しているのがUNIXの大きな特徴です。
あらゆるファイルのやり取りも**ファイルディスクリプタ(file descripter)**を用います。

|UNIXにあるシステムコール|役割|
|---|---|
|`read()`|データを読み込む|
|`write()`|データを書き込む|

これらの第1引数は「ファイルディスクリプタ」です。それぞれファイルディスクリプタに指定されているデータに対して読み書きします。
コンピュータ内のファイルを開いてデータを読み込む場合は、`open()`というシステムコールを使ってファイルを「開く」ことでファイルディスクリプタを得ることができます。そのファイルディスクリプタを用いて`read()`を実行することで、データを読み込むことができるという仕組みです。

UNIXではプロセスがつくられたときに、自動的に用意されるファイルディスクリプタがあります。
OS実装での共通APIを定義しているPOSIX(Portable Operating System Interface)では、ターミナル出力用のファイルディスクリプタとして、以下のようなものがあります。

また、実際はファイルディスクリプタは整数値として表現されているので、引数に直接整数値を入れてもプログラムは動作します。

|共通API|役割|実装上の整数値|
|---|---|---|
|`stdin`|標準入力|0|
|`stdout`|標準出力|1|
|`stderr`|標準エラー出力|2|

```c
#include <unistd.h>

int
main(void)
{
    write(1, "HELLO¥n", 6); // 整数値で指定しても動作する（1）
}
```
```
> ./a.out
HELLO
>
```

UNIXではソケットでもファイルディスクリプタを使います。
ただし、コンピュータ内のファイルを開くための`open()`とは違い、ソケットを生成するためのシステムコールは`socket()`となります。

## 通信の入り口となる「ソケット」、何と通信するかを指定する「ポート」

ソケットを使ってTCP通信をする例

1. ソケットを用意する
2. ソケットにIPアドレスとポートを指定する
3. 相手と接続する
4. 情報のやり取りをする

### ソケットを用意する

通信を行うための「口」を用意するイメージです。

用意する際にソケットをどう使いたいかを指定します。
例えばインターネットを使ってWebサーバと通信するのであれば、「TCPで通信するためのソケット」を用意します。

### ソケットにIPアドレスとポートを指定する

- IPアドレス：通信相手の指定
- ポート：通信の種類の指定

### 相手と接続する

通信によってこの工程が必要な場合と、必要ではない場合があります。
TCPは「接続」が必要になります。

### 情報のやり取りをする

一度つながってしまえば、ユーザーからするとコンピュータ内のファイルとのやり取りも、ネットワークの向こう側のサーバ内のファイルとのやり取りも、同じ感覚で利用することができます。

次章は「インターネットの仕組み」の紹介です。
